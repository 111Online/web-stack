@using Microsoft.Ajax.Utilities
@using NHS111.Models.Models.Web
@using NHS111.Models.Models.Web.FromExternalServices
@inherits NHS111.Web.Views.Shared.SurveyLinkView<NHS111.Models.Models.Web.SurveyLinkViewModel>

@{
    var launchPage = ViewData.ContainsKey("LaunchPage") ? ViewData["LaunchPage"] : "outcome";
    var itkOffered = false;
    var serviceOptions = new List<OnlineDOSServiceType>();
    var services = new List<ServiceViewModel>();
    if (Model.OfferedServices != null) {
        services = Model.OfferedServices.SelectMany(g => g.Services).ToList();
        itkOffered = services.Any(s => s.OnlineDOSServiceType == OnlineDOSServiceType.Callback);
        serviceOptions = services.DistinctBy(s => s.OnlineDOSServiceType).Select(s => s.OnlineDOSServiceType).ToList();
    }
}

@if (SurveyLinkFeature.IsEnabled)
{
    var baseUrl = SurveyLinkFeature.BaseUrl;
    var url = string.Format(
        baseUrl,
        SurveyLinkFeature.SurveyId,
        Model.JourneyId,
        Model.PathwayNo,
        Model.EndPathwayNo,
        Model.DispositionCode,
        launchPage,
        Model.DigitalTitle.ToLower(),
        Model.EndPathwayTitle,
        Model.DispositionDateTime.Date.ToString("dddd, dd MMMM yyyy"),
        Model.DispositionDateTime.ToString("HH:mm:ss"),
        Model.Campaign,
        Model.CampaignSource,
        services.Count,
        string.Join(",", serviceOptions)
        );


    <div class="notification-banner notification-banner--hiviz">
        <p class="notification-banner--inner">
            When you’ve finished, help us improve by taking a <a href="@url" target="_blank">short survey</a>
        </p>
    </div>

    <script>

        $(document)
            .ready(function () {
                if (!$.cookie("nhs111-survey-link-banner")) {
                    $(".survey-banner-wrap").show();
                }
            });

        $("#AgreeButton")
            .click(function () {
                var isSecure = window.location.protocol.toLowerCase() == 'https:';
                $.cookie("nhs111-survey-link-banner", "survey-link-yes", { path: '/', secure: isSecure });
                $(".survey-banner-wrap").hide();
            });

        $("#PostponeButton")
            .click(function () {
                $(".survey-banner-wrap").hide();
            });
    </script>
}