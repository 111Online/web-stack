@using NHS111.Models.Models.Web
@using NHS111.Models.Models.Web.FromExternalServices
@model OutcomeViewModel
<script src="http://maps.google.com/maps/api/js?key=AIzaSyCv3YwvmRoueyoLcW2iiSPjVeHecU18hmA "
        type="text/javascript"></script>
<script src="/Scripts/geotools.js"
        type="text/javascript"></script>
@{
    Layout = "~/Views/Shared/_LayoutNhsUk.cshtml";
}

@section Title {
    Service details
}

@section OuterSection{
    @Html.Partial("_OutcomeHeader", Model, new ViewDataDictionary { { "DefaultTitle", "Your answers suggest you should go to an Accident and Emergency department within 1 hour" } })
}

@section FeedbackSection {
    @Html.Partial("_FeedbackDetails", new FeedbackViewModel() { PageId = Model.Id })
}

<link href="~/content/css_NhsUk/servicelist.css" media="screen" rel="stylesheet" type="text/css"/>
<link href="~/content/css_NhsUk/service.css" media="screen" rel="stylesheet" type="text/css"/>

<section>
    <div class="service-list-header">
        <h2>
            Recommended @Html.Raw(Model.OutcomeGroup.Label) for @Model.UserInfo.CurrentAddress.PostCode
        </h2>
    </div>
</section>
<div class="results-list">

    <section>
        <div class="results-service-recommended section-item">
            <h3 class="section-header">
                Recommended service
            </h3>
            @{
                DosService selectedService = null;
                if (Model.DosCheckCapacitySummaryResult.Success != null)
                {
                    selectedService = Model.DosCheckCapacitySummaryResult.Success.Services.FirstOrDefault();
                }
            }
            @if (selectedService != null)
            {
                <div class="service-list-content">

                    <div class="form-item-wrapper">
                        <fieldset>
                            <div class="form-group">

                                <div class="service-name">
                                    <img src="/content/images/icons/map-pointers/fac-map-1.png"/>
                                    @WebUtility.HtmlDecode(selectedService.Name)
                                </div>
                                <div class="service-address">
                                    @WebUtility.HtmlDecode(selectedService.Address)
                                </div>

                                <a class="button button-next" href="http://maps.google.com/maps?q=@selectedService.Address">Get Directions</a>
                            </div>
                        </fieldset>
                    </div>
                </div>
            }
        </div>
    </section>

    <section>
        <div class="section-item last">

            @if (Model.DosCheckCapacitySummaryResult.Success != null)
            {
                var pointerNo = 1;
                foreach (var service in Model.DosCheckCapacitySummaryResult.Success.Services.Skip(1))
                {
                    pointerNo++;
                    var pointerimageSrc = "/content/images/icons/map-pointers/fac-map-" + pointerNo.ToString() + ".png";
                    <div class="service-list-content">
                        <fieldset>
                            <div class="service-name">
                                <img src="@pointerimageSrc"/>
                                @WebUtility.HtmlDecode(service.Name)
                            </div>
                            <div class="service-address">
                                @WebUtility.HtmlDecode(service.Address)
                            </div>
                            <a href="http://maps.google.com/maps?q=@service.Address">Get Directions</a>
                        </fieldset>
                    </div>
                }
            }
        </div>
    </section>

  

    <script type="text/javascript">

        var locations = [
            @{ int i = 0; }
            @if (Model.DosCheckCapacitySummaryResult.Success != null)
            {
                foreach (var service in Model.DosCheckCapacitySummaryResult.Success.Services)
                {


                    @Html.Raw("['" + service.Name + "',OsGridRef.osGridToLatLon(new OsGridRef(" + service.Eastings + ", " + service.Northings + "), LatLon.datum.OSGB36).lat, OsGridRef.osGridToLatLon(new OsGridRef(" + service.Eastings + ", " + service.Northings + "), LatLon.datum.OSGB36).lon, " + i + "],")
                    i++;
                }
            }
        ];
    </script>

</div>
<div class="service-map" ></div>

<script type="text/javascript">
   
    var map = new google.maps.Map($('.service-map')[0], {
        zoom: 10,
        center: new google.maps.LatLng(locations[0][1], locations[0][2]),
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    var infowindow = new google.maps.InfoWindow();

    var marker, i;

    for (i = 0; i < locations.length; i++) {
        var pointerNo = i + 1;
        marker = new google.maps.Marker({
            position: new google.maps.LatLng(locations[i][1], locations[i][2]),
            map: map,
            icon: "/content/images/icons/map-pointers/fac-map-" + pointerNo + ".png"
        });

        google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {
                infowindow.setContent(locations[i][0]);
                infowindow.open(map, marker);
            }
        })(marker, i));
    }


</script>
<section>
    <div class="section-item last">
        @Html.Partial("_CareAdvice", Model.CareAdvices, new ViewDataDictionary { { "Title", "Advice to help you look after yourself" } })
    </div>
</section>